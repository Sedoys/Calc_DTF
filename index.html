<!-- Калькулятор ДТФ 4.1 — Финальная исправленная версия -->
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>Калькулятор ДТФ 4.1 (Skyline)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:Inter,system-ui,Arial,sans-serif;padding:18px;background:#f5f7fb;margin:0;color:#222}
  .container{max-width:1100px;margin:0 auto}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  h1{margin:0;color:#1f4eda;font-size:20px}
  .sub{color:#666;font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
  .block{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 20px rgba(20,30,60,0.06)}
  label{display:block;font-size:13px;color:#444;margin-bottom:8px}
  input,select,button{font-size:13px}
  input,select{padding:6px;border-radius:8px;border:1px solid #e0e6ef;background:#fff;font-size:13px;max-width:90px}
  button{padding:8px 10px;border-radius:8px;border:none;background:#1f4eda;color:#fff;cursor:pointer}
  .row{display:flex;gap:8px;align-items:center}
  .muted{color:#777;font-size:13px}
  #printsContainer .print-row{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin-bottom:8px}
  .small-btn{padding:6px 8px;border-radius:6px;border:none;color:#fff;cursor:pointer}
  .auto-btn{background:#6fb3d2}
  .rot90-btn{background:#2b6acb}
  .del-btn{background:#e05d5d}
  #previewWrapper{display:flex;flex-direction:column;align-items:flex-start;padding-left:40px;}
  #rollWidthIndicator{font-weight:600;margin-bottom:8px;color:#333}
  #previewCanvas{position:relative;background:#fff;border:2px dashed #bdbdbd;border-radius:8px;overflow:auto; max-width:100%;}{position:relative;background:#fff;border:2px dashed #bdbdbd;border-radius:8px;overflow:auto}
  .print-rect{position:absolute;background:rgba(31,78,218,0.14);border:1px solid rgba(31,78,218,0.35);color:#08306b;font-size:11px;display:flex;align-items:center;justify-content:center;border-radius:4px;box-sizing:border-box}
  #result{white-space:pre-line;font-weight:600}
  .info-line{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  @media(max-width:900px){.grid{grid-template-columns:1fr;}.header{flex-direction:column;align-items:flex-start;gap:6px} #previewCanvas{width:100%}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <h1 id="title">Калькулятор ДТФ 4.1</h1>
      <div class="sub">ARI-PRINT.RU</div>
    </div>
    <div class="muted">Версия: 4.1 (Skyline)</div>
  </div>

  <div class="grid">
    <div>
      <div class="block">
        <div class="block-title">Основные параметры</div>
        <div class="row" style="margin-bottom:10px">
          <label style="width:120px">Тип печати</label>
          <select id="modeSelect"><option value="DTF">DTF</option><option value="UF">UF DTF</option></select>
        </div>
        <div class="row" style="margin-bottom:10px">
          <label style="width:120px">Цена за метр</label>
          <input id="pricePerMeter" type="number" value="1600" step="1" />
        </div>
        <div class="row">
          <label style="width:120px">Отступы (см)</label>
          <div class="row" style="gap:6px">
            <input id="gapX" type="number" step="0.1" value="0.3" style="width:70px" placeholder="Ширина" />
            <input id="gapY" type="number" step="0.1" value="0.3" style="width:70px" placeholder="Высота" />
          </div>
        </div>
      </div>

      <div class="block" style="margin-top:12px">
        <div class="block-title">Доп. услуги</div>
        <div class="row">
          <label style="display:flex;align-items:center;gap:8px"><input id="applyToggle" type="checkbox"> Нанесение</label>
          <label>Цена/шт <input id="applyPrice" type="number" value="0" /></label>
        </div>
        <div class="row" style="margin-top:8px">
          <label style="display:flex;align-items:center;gap:8px"><input id="cutToggle" type="checkbox"> Нарезка принтов</label>
          <label>Цена/м <input id="cutPrice" type="number" value="400" /></label>
        </div>
        <div class="row" style="margin-top:8px">
          <label style="display:flex;align-items:center;gap:8px"><input id="contourToggle" type="checkbox"> Контурная резка</label>
          <label>Цена/м <input id="contourPrice" type="number" value="400" /></label>
        </div>
      </div>

      <div class="block" style="margin-top:12px">
        <div class="block-title">Принты</div>
        <div id="printsContainer"></div>
        <div style="margin-top:10px"><button id="addPrint" type="button">+ Добавить принт</button></div>
      </div>

    </div>

    <div>
      <div class="block">
        <div class="info-line"><div class="muted">Итог</div><div id="result">Метраж: 0.00 м — 0 ₽</div></div>
        <div id="previewWrapper">
          <div id="rollWidthIndicator">↔ Ширина печати: 58 см</div>
          <div id="previewCanvas" style="width:464px;min-height:200px"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
'use strict';
// Simple, robust Skyline-based layout — cleaned and fixed for syntax issues
const SCALE = 8; // px per cm
const DEFAULT_ROLL = 58;
let skyline = [];

// DOM refs
const modeSelect = document.getElementById('modeSelect');
const pricePerMeterInput = document.getElementById('pricePerMeter');
const gapXInput = document.getElementById('gapX');
const gapYInput = document.getElementById('gapY');
const applyToggle = document.getElementById('applyToggle');
const applyPriceInput = document.getElementById('applyPrice');
const cutToggle = document.getElementById('cutToggle');
const cutPriceInput = document.getElementById('cutPrice');
const contourToggle = document.getElementById('contourToggle');
const contourPriceInput = document.getElementById('contourPrice');
const printsContainer = document.getElementById('printsContainer');
const addPrintBtn = document.getElementById('addPrint');
const previewCanvas = document.getElementById('previewCanvas');
const rollWidthIndicator = document.getElementById('rollWidthIndicator');
const resultBox = document.getElementById('result');

let priceManuallyChanged = false;

function getRollWidth(){ return (cutToggle.checked || contourToggle.checked) ? 57 : DEFAULT_ROLL; }

function skylineInit(){ skyline = [{x:0,y:0,width:getRollWidth()}]; previewCanvas.style.width = (getRollWidth()*SCALE) + 'px'; rollWidthIndicator.textContent = '\u2194 Ширина печати: ' + getRollWidth() + ' см'; }

function skylineCanPlaceAt(arr, i, w){
  var line = arr[i];
  var x = line.x, y = line.y, need = w, collected = 0, idx = i;
  while(idx < arr.length && collected < need){ if(arr[idx].y > y) return null; collected += arr[idx].width; idx++; }
  return collected >= need ? {x:x, y:y} : null;
}

function skylineFindPosition(arr, w, h){
  var bestY = Infinity, bestX = 0;
  for(var i=0;i<arr.length;i++){
    var pos = skylineCanPlaceAt(arr, i, w);
    if(!pos) continue;
    var top = pos.y + h;
    if(top < bestY){ bestY = top; bestX = pos.x; }
  }
  if(!isFinite(bestY)){
    var maxY = 0; for(var j=0;j<arr.length;j++) if(arr[j].y > maxY) maxY = arr[j].y;
    return {x:0, y:maxY};
  }
  return {x: bestX, y: bestY - h};
}

function skylineAddLevel(arr, x, y, w, h){
  // split existing segments by coverage and insert new top
  var newSegs = [];
  var endX = x + w;
  for(var i=0;i<arr.length;i++){
    var s = arr[i]; var sStart = s.x; var sEnd = s.x + s.width;
    if(sEnd <= x || sStart >= endX){ newSegs.push({x:s.x,y:s.y,width:s.width}); continue; }
    if(sStart < x) newSegs.push({x:sStart,y:s.y,width:x - sStart});
    if(sEnd > endX) newSegs.push({x:endX,y:s.y,width:sEnd - endX});
  }
  newSegs.push({x:x,y:y + h,width:w});
  newSegs.sort(function(a,b){ return a.x - b.x; });
  // merge neighbors with same y
  for(var j=0;j<newSegs.length-1;j++){ var A=newSegs[j], B=newSegs[j+1]; if(Math.abs(A.y - B.y) < 1e-9 && Math.abs(A.x + A.width - B.x) < 1e-9){ A.width += B.width; newSegs.splice(j+1,1); j--; }}
  arr.length = 0; for(var k=0;k<newSegs.length;k++) arr.push(newSegs[k]);
}

function getPriceByMeters(mode, meters){
  if(mode === 'DTF'){
    if(meters < 1) return 1600; if(meters < 3) return 1400; if(meters < 10) return 1300; if(meters < 30) return 1120; if(meters < 50) return 900; return 850;
  } else {
    if(meters < 1) return 3000; if(meters < 3) return 2000; if(meters < 5) return 1800; if(meters < 11) return 1600; if(meters < 30) return 1400; return 1300;
  }
}

function createPrintRow(w,h,q){
  w = w || ''; h = h || ''; q = q || 1;
  var row = document.createElement('div'); row.className='print-row'; row.dataset.rotated='0';
  var labW = document.createElement('label'); labW.textContent='Ширина '; var inpW=document.createElement('input'); inpW.type='number'; inpW.step='0.1'; inpW.className='pw'; inpW.value=w; labW.appendChild(inpW);
  var labH = document.createElement('label'); labH.textContent='Высота '; var inpH=document.createElement('input'); inpH.type='number'; inpH.step='0.1'; inpH.className='ph'; inpH.value=h; labH.appendChild(inpH);
  var labQ = document.createElement('label'); labQ.textContent='Кол-во '; var inpQ=document.createElement('input'); inpQ.type='number'; inpQ.min='1'; inpQ.className='pq'; inpQ.value=q; labQ.appendChild(inpQ);
  var controls=document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px'; controls.style.alignItems='center';
  var autoBtn=document.createElement('button'); autoBtn.type='button'; autoBtn.className='small-btn auto-btn'; autoBtn.textContent='AUTO';
  var rotBtn=document.createElement('button'); rotBtn.type='button'; rotBtn.className='small-btn rot90-btn'; rotBtn.textContent='90°';
  var delBtn=document.createElement('button'); delBtn.type='button'; delBtn.className='small-btn del-btn'; delBtn.textContent='×';
  var indicator=document.createElement('span'); indicator.className='group-indicator muted'; indicator.style.marginLeft='6px';
  controls.appendChild(autoBtn); controls.appendChild(rotBtn); controls.appendChild(delBtn); controls.appendChild(indicator);
  row.appendChild(labW); row.appendChild(labH); row.appendChild(labQ); row.appendChild(controls);

  function markAuto(){ row.dataset.rotated='0'; indicator.textContent=''; }
  function markRot(){ row.dataset.rotated='1'; indicator.textContent='rot'; }

  inpW.addEventListener('input', function(){ markAuto(); layout(); }); inpH.addEventListener('input', function(){ markAuto(); layout(); }); inpQ.addEventListener('input', function(){ layout(); });

  autoBtn.addEventListener('click', function(){ var key=String(inpW.value)+'x'+String(inpH.value); document.querySelectorAll('#printsContainer .print-row').forEach(function(r){ var k=r.querySelector('.pw').value+'x'+r.querySelector('.ph').value; if(k===key){ r.dataset.rotated='0'; r.querySelector('.group-indicator').textContent=''; }}); layout(); });

  rotBtn.addEventListener('click', function(){ var key=String(inpW.value)+'x'+String(inpH.value); var rows=document.querySelectorAll('#printsContainer .print-row'); var any=false; rows.forEach(function(r){ var k=r.querySelector('.pw').value+'x'+r.querySelector('.ph').value; if(k===key && r.dataset.rotated==='1') any=true; }); var nv = any ? '0' : '1'; rows.forEach(function(r){ var k=r.querySelector('.pw').value+'x'+r.querySelector('.ph').value; if(k===key){ r.dataset.rotated=nv; r.querySelector('.group-indicator').textContent = nv==='1' ? 'rot' : ''; }}); layout(); });

  delBtn.addEventListener('click', function(){ row.remove(); layout(); });
  printsContainer.appendChild(row);
  return row;
}

addPrintBtn.addEventListener('click', function(e){ e.preventDefault(); createPrintRow(); layout(); });
addPrintBtn.addEventListener('touchstart', function(e){ e.preventDefault(); createPrintRow(); layout(); });

function layout(){
  previewCanvas.innerHTML=''; skylineInit();
  var gapX = parseFloat(gapXInput.value) || 0; var gapY = parseFloat(gapYInput.value) || 0;

  // build groups (B1) — sum quantities by exact size
  var groups = new Map(); var rows = printsContainer.querySelectorAll('.print-row');
  rows.forEach(function(r){ var w=parseFloat(r.querySelector('.pw').value)||0; var h=parseFloat(r.querySelector('.ph').value)||0; var q=Math.max(1, parseInt(r.querySelector('.pq').value)||1); var key=w+'x'+h; if(!groups.has(key)) groups.set(key,{w:w,h:h,qty:0,manual:false}); var g=groups.get(key); g.qty += q; if(r.dataset.rotated==='1') g.manual=true; });

  // prepare rects array
  var rects = [];
  groups.forEach(function(g,key){ var w=g.w,h=g.h,qty=g.qty,manual=g.manual; var finalW, finalH; var rollW=getRollWidth();
    if(!manual){ var fitsNormal = (w + gapX) <= rollW; var fitsRot = (h + gapX) <= rollW; if(!fitsNormal && fitsRot){ finalW = h; finalH = w; } else if(!fitsRot && fitsNormal){ finalW = w; finalH = h; } else if(!fitsNormal && !fitsRot){ finalW = w; finalH = h; } else {
        // both fit — simulate group placement in both orientations
        function simulate(orig,count,rw,rh){ var sim=JSON.parse(JSON.stringify(orig)); var maxY=0; for(var i=0;i<count;i++){ var pw=rw+gapX; var ph=rh+gapY; var p=skylineFindPosition(sim,pw,ph); if(!isFinite(p.y)){ var m=0; for(var jj=0;jj<sim.length;jj++) if(sim[jj].y>m) m=sim[jj].y; p={x:0,y:m}; } skylineAddLevel(sim,p.x,p.y,pw,ph); if(p.y+ph>maxY) maxY=p.y+ph; } return maxY; }
        var sim1=simulate(JSON.parse(JSON.stringify(skyline)),qty,w,h); var sim2=simulate(JSON.parse(JSON.stringify(skyline)),qty,h,w); if(sim2 < sim1){ finalW = h; finalH = w; } else { finalW = w; finalH = h; }
      }
    } else { finalW = h; finalH = w; }
    for(var k=0;k<qty;k++) rects.push({w:finalW,h:finalH,origW:w,origH:h}); });

  // sort largest first
  rects.sort(function(a,b){ return Math.max(b.w,b.h) - Math.max(a.w,a.h); });

  var maxY = 0;
  rects.forEach(function(r){ var placeW=r.w+gapX; var placeH=r.h+gapY; var pos=skylineFindPosition(skyline,placeW,placeH); if(!isFinite(pos.y)){ var m=0; for(var jj=0;jj<skyline.length;jj++) if(skyline[jj].y>m) m=skyline[jj].y; pos={x:0,y:m}; } skylineAddLevel(skyline,pos.x,pos.y,placeW,placeH); var el=document.createElement('div'); el.className='print-rect'; el.style.left=(pos.x*SCALE)+'px'; el.style.top=(pos.y*SCALE)+'px'; el.style.width=(r.w*SCALE)+'px'; el.style.height=(r.h*SCALE)+'px'; el.textContent = String(r.w)+'x'+String(r.h); previewCanvas.appendChild(el); if(pos.y+placeH>maxY) maxY=pos.y+placeH; });

  var meters = Math.ceil((maxY/100) * 100) / 100; // round up to hundredths
  if(!priceManuallyChanged) pricePerMeterInput.value = getPriceByMeters(modeSelect.value, meters);
  var pricePerMeter = parseFloat(pricePerMeterInput.value) || 0; var printCost = meters * pricePerMeter;
  var totalInstances = rects.length; var applyCost = applyToggle.checked ? totalInstances * (parseFloat(applyPriceInput.value)||0) : 0; var cutCost = cutToggle.checked ? meters * (parseFloat(cutPriceInput.value)||0) : 0; var contourCost = contourToggle.checked ? meters * (parseFloat(contourPriceInput.value)||0) : 0; var total = printCost + applyCost + cutCost + contourCost;

  var lines = [];
  var pricePerItem = 0; var rowsCount = groups.size;
  if(applyToggle.checked && totalInstances>0){ var basePrice = total / totalInstances; pricePerItem = basePrice * rowsCount; }
  lines.push('Метраж: ' + meters.toFixed(2) + ' м — ' + printCost.toFixed(0) + ' ₽');
  if(applyToggle.checked) lines.push('Нанесение: ' + applyCost.toFixed(0) + ' ₽');
  if(cutToggle.checked) lines.push('Нарезка: ' + cutCost.toFixed(0) + ' ₽');
  if(contourToggle.checked) lines.push('Контур: ' + contourCost.toFixed(0) + ' ₽');
  if(applyToggle.checked) lines.push('Цена за изделие: ' + pricePerItem.toFixed(2) + ' ₽');
  lines.push('Итого: ' + total.toFixed(0) + ' ₽');
  resultBox.innerHTML = lines.map(function(l){ return '<div>'+l+'</div>'; }).join('');
}

modeSelect.addEventListener('change', function(){ priceManuallyChanged=false; if(modeSelect.value==='DTF'){ gapXInput.value='0.3'; gapYInput.value='0.3'; } else { gapXInput.value='0.4'; gapYInput.value='0.4'; } layout(); });
pricePerMeterInput.addEventListener('input', function(){ priceManuallyChanged=true; layout(); });
[gapXInput,gapYInput,applyToggle,applyPriceInput,cutToggle,cutPriceInput,contourToggle,contourPriceInput].forEach(function(el){ if(!el) return; el.addEventListener('input', layout); el.addEventListener('change', layout); });

// Начальная загрузка без предустановленных принтов
layout();

})();
</script>
</body>
</html>
